<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quest 3 Button Press Example</title>
  <script src="aframe-master.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene> 
    <a-assets> 
      <audio id="river" src="assets/wow.ogg"></audio>
      <a-asset-item id="kick" src="assets/scene.gltf"></a-asset-item>
    </a-assets>

<!--   <a-entity camera look-controls position="0 1.6 0"></a-entity>
<a-entity rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
        <a-sphere position="5 0 0" color="mediumseagreen"></a-sphere>
</a-entity>-->

  
    <a-entity id="my-entity" gltf-model="#kick" animation-mixer
     animation-move='path: [ {"position": {"x": 15.020, "y": 15.500, "z": 7.958}}, {"position": {"x": 10, "y": 17.000, "z": 5}} ]; animationStepTime: 1500' rotation="0 0 0"></a-entity>
    <a-entity id="riverSound" sound="src: #river"></a-entity> 
    
    <!-- Controller -->
    <a-entity
      id="right-hand"
      hand-controls="hand: right"
      oculus-touch-controls="hand: right"
    ></a-entity>

    <!-- Controller -->
    <a-entity
      id="left-hand"
      hand-controls="hand: left"
      oculus-touch-controls="hand: left"
    ></a-entity>

    <!-- Square Template (hidden initially) -->
    <a-entity id="square-template" visible="false">
      <a-box
        position="0 0 -1"
        width="0.5"
        height="0.5"
        depth="0.5"
        color="yellow"
      ></a-box>
    </a-entity>


    <!-- Event Listener for Button Press -->
    <a-entity>
      <a-animation
        id="button-press-animation"
        attribute="visible"
        begin="button-press"
        from="false"
        to="true"
      ></a-animation>
    </a-entity>
    <script>
      const rightHand = document.querySelector('#right-hand');
      const leftHand = document.querySelector('#left-hand');
      const squareTemplate = document.querySelector('#square-template');

AFRAME.registerComponent('animation-move', {
  schema: {
    path: {
      default: [],
      parse: function (value) {
        return JSON.parse(value);
      }
    },
    animationStepTime: {
      type: 'int',
      default: 0
    }
  },
  init: function(){
    this.next = 0;
    let object = this.el;
    for (let prop in this.data.path[this.next]) {
      object.setAttribute( prop, this.data.path[this.next][prop] );
    }
  },
  tick: function (time, timeDelta) {
    let updated = false

    if ( this.next >= this.data.path.length ) {
      this.next = 0;
    }

    let delta = this.data.animationStepTime / (16.7 * ((this.data.animationStepTime+timeDelta)/this.data.animationStepTime));
    let object = this.el;

    for (let prop in this.data.path[this.next]) {

      let attr = object.getAttribute(prop);
      let nextStep = this.data.path[this.next][prop];

      let xDelta = Math.abs( (this.next-1 >= 0) ? nextStep.x - this.data.path[this.next-1][prop].x : nextStep.x - this.data.path[this.data.path.length-1][prop].x)/delta;
      let yDelta = Math.abs( (this.next-1 >= 0) ? nextStep.y - this.data.path[this.next-1][prop].y : nextStep.y - this.data.path[this.data.path.length-1][prop].y)/delta;
      let zDelta = Math.abs( (this.next-1 >= 0) ? nextStep.z - this.data.path[this.next-1][prop].z : nextStep.z - this.data.path[this.data.path.length-1][prop].z)/delta;

      if (attr.x != nextStep.x) {
        if ((this.next-1 >= 0 && nextStep.x < this.data.path[this.next-1][prop].x) || (this.next == 0 && nextStep.x < this.data.path[this.data.path.length-1][prop].x)) {
          if (attr.x-xDelta < nextStep.x) {
            attr.x = nextStep.x;
          }
          else {
            attr.x -= xDelta;
            updated = true;
          }
        }
        else if (this.next-1 >= 0 && nextStep.x > this.data.path[this.next-1][prop].x || (this.next == 0 && nextStep.x > this.data.path[this.data.path.length-1][prop].x)) {
          if (attr.x+xDelta > nextStep.x) {
            attr.x = nextStep.x;
          }
          else {
            attr.x += xDelta;
            updated = true;
          }
        }
        else {
          attr.x = nextStep.x;
        }
      }

      if (attr.y != nextStep.y) {
        if (this.next-1 >= 0 && nextStep.y < this.data.path[this.next-1][prop].y || (this.next == 0 && nextStep.y < this.data.path[this.data.path.length-1][prop].y)) {
          if (attr.y-yDelta < nextStep.y) {
            attr.y = nextStep.y;
          }
          else {
            attr.y -= yDelta;
            updated = true;
          }
        }
        else if (this.next-1 >= 0 && nextStep.y > this.data.path[this.next-1][prop].y || (this.next == 0 && nextStep.y > this.data.path[this.data.path.length-1][prop].y)) {
          if (attr.y+yDelta > nextStep.y) {
            attr.y = nextStep.y;
          }
          else {
            attr.y += yDelta;
            updated = true;
          }
        }
        else {
          attr.y = nextStep.y;
        }
      }

      if (attr.z != nextStep.z) {
        if (this.next-1 >= 0 && nextStep.z < this.data.path[this.next-1][prop].z || (this.next == 0 && nextStep.z < this.data.path[this.data.path.length-1][prop].z)) {
          if (attr.z-zDelta < nextStep.z) {
            attr.z = nextStep.z;
          }
          else {
            attr.z -= zDelta;
            updated = true;
          }
        }
        else if (this.next-1 >= 0 && nextStep.z > this.data.path[this.next-1][prop].z || (this.next == 0 && nextStep.z > this.data.path[this.data.path.length-1][prop].z)) {
          if (attr.z+zDelta > nextStep.z) {
            attr.z = nextStep.z;
          }
          else {
            attr.z += zDelta;
            updated = true;
          }
        }
        else {
          attr.z = nextStep.z;
        }
      }

      object.setAttribute( prop, attr.x+' '+attr.y+' '+attr.z );
    }
    if (!updated) {
      this.next++;
    }
  }
});


      // Function to create and position a box
      function createBox(color) {
        // Clone the square template
        const square = squareTemplate.cloneNode(true);
        square.setAttribute('visible', true);

        // Find the <a-box> child inside the cloned template and set its color
        const box = square.querySelector('a-box');
        box.setAttribute('color', color);

        // Position the square in front of the controller
        const controllerPosition = rightHand.getAttribute('position');
        const controllerRotation = rightHand.getAttribute('rotation');
        square.setAttribute('position', {
          x: controllerPosition.x,
          y: controllerPosition.y,
          z: controllerPosition.z - 1
        });
        square.setAttribute('rotation', controllerRotation);

        // Add the square to the scene
        square.removeAttribute('id'); // Remove the template ID
        document.querySelector('a-scene').appendChild(square);
      }

      // Function to create and position a ball
      function createBall(color) {
        // Clone the square template (acts as a base container)
        const ball = squareTemplate.cloneNode(true);
        ball.setAttribute('visible', true);

        // Replace the <a-box> in the template with a <a-sphere>
        const box = ball.querySelector('a-box');
        const sphere = document.createElement('a-sphere');
        sphere.setAttribute('radius', 0.25);
        sphere.setAttribute('color', color);
        ball.replaceChild(sphere, box);

        // Position the ball in front of the controller
        const controllerPosition = rightHand.getAttribute('position');
        const controllerRotation = rightHand.getAttribute('rotation');
        ball.setAttribute('position', {
          x: controllerPosition.x,
          y: controllerPosition.y,
          z: controllerPosition.z - 1
        });
        ball.setAttribute('rotation', controllerRotation);

        ball.removeAttribute('id'); // Remove the template ID
        document.querySelector('a-scene').appendChild(ball);
      }

      // Function to create falling particles from the sky for 5 seconds
      function createFallingParticles() {
        const scene = document.querySelector('a-scene');
        const particles = [];
        const particleCount = 20;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('a-sphere');
          particle.setAttribute('radius', 0.1);
          particle.setAttribute('color', '#FFF');
          const x = Math.random() * 4 - 2;
          const z = Math.random() * 4 - 2;
          particle.setAttribute('position', { x: x, y: 5, z: z });
          particle.setAttribute('animation', `property: position; to: ${x} 0 ${z}; dur: 5000; easing: linear;`);
          scene.appendChild(particle);
          particles.push(particle);
        }
        // Remove particles after 5 seconds
        setTimeout(() => {
          particles.forEach(particle => particle.parentNode.removeChild(particle));
        }, 5000);
      }

      // Create a blue ball on A button press
      rightHand.addEventListener('abuttondown', () => {
         createBall('blue');
      });

      // Play sound on B button press
      rightHand.addEventListener('bbuttondown', () => {
        var enti = document.querySelector('#riverSound');
        enti.components.sound.playSound();
      });

      // Create falling particles from the sky for 5 seconds on axis move
      rightHand.addEventListener('axismove', () => {
         createFallingParticles();
      });

      // Create a green box on trigger button press
      rightHand.addEventListener('triggerdown', () => {
        createBox('green');        
      });

      // Create a blue box on grip button press
      rightHand.addEventListener('gripdown', () => {
        createBox('blue');        
      });

      leftHand.addEventListener('triggerdown', () => {
         const scene = document.querySelector('a-scene');
         const numbers = [];
         const count = 50;
         for (let i = 0; i < count; i++) {
           const numberEl = document.createElement('a-text');
           const randomNumber = Math.floor(Math.random() * 10);
           numberEl.setAttribute('value', randomNumber);
           numberEl.setAttribute('color', 'green');
           numberEl.setAttribute('position', {
             x: (Math.random() - 0.5) * 10,
             y: Math.random() * 5 + 1,
             z: (Math.random() - 0.5) * 10
           });
           numberEl.setAttribute('opacity', 1);
           numberEl.setAttribute('animation', {
             property: 'opacity',
             to: 0,
             dur: 3000,
             easing: 'linear'
           });
           scene.appendChild(numberEl);
           numbers.push(numberEl);
         }
         // Remove the green numbers after 3 seconds
         setTimeout(() => {
           numbers.forEach(el => {
             if (el.parentNode) {
               el.parentNode.removeChild(el);
             }
           });
         }, 3000);
      }
      );
    </script>
  </a-scene>
</body>
</html>
